name: Auto Create / Update Security Issues (Dependabot API)

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  security-events: read

jobs:
  dependabot-alerts:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch Dependabot alerts
        id: fetch
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.DEPENDABOT_PAT }}
        with:
          script: |
            const alerts = await github.paginate(
              github.rest.dependabot.listAlertsForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                per_page: 100
              }
            );
            return alerts;

      - name: Process alerts
        uses: actions/github-script@v7
        env:
          GITHUB_TOKEN: ${{ secrets.DEPENDABOT_PAT }}
        with:
          script: |
            const alerts = ${{ steps.fetch.outputs.result }};
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner,
                repo,
                state: 'all',
                labels: 'Auto Create Issues',
                per_page: 100
              }
            );

            for (const alert of alerts) {
              const ghsa = alert.security_advisory.ghsa_id;
              const cve = alert.security_advisory.cve_id || 'No CVE';
              const severity = alert.security_advisory.severity.toUpperCase();
              const cvss = alert.security_advisory.cvss?.score ?? 'N/A';
              const vector = alert.security_advisory.cvss?.vector_string ?? 'N/A';

              const pkg = alert.dependency.package.name;
              const eco = alert.dependency.package.ecosystem;

              const vuln = alert.vulnerabilities?.[0];
              const vulnRange = vuln?.vulnerable_version_range ?? 'Unknown';
              const patched = vuln?.first_patched_version?.identifier ?? 'None';

              const title = `Security: ${severity} - ${pkg} (${ghsa} / ${cve})`;
              const existing = issues.find(i => i.title === title);

              const body = `
            ## Description
            This affects versions of **${pkg}** and was detected automatically by Dependabot.
            
            Example:
            This affects all versions of package **${pkg}** within the vulnerable range.
            
            ---
            
            ## Severity Check
            - [${severity === 'LOW' ? 'x' : ' '}] Low
            - [${severity === 'MODERATE' ? 'x' : ' '}] Moderate
            - [${severity === 'HIGH' ? 'x' : ' '}] High
            - [${severity === 'CRITICAL' ? 'x' : ' '}] Critical
            
            ---
            
            ## Severity Number
            ${cvss} / 10
            
            ---
            
            ## CVSS base metrics
            ${vector}
            
            Example:
            - **Attack vector**
              Network
            - **Attack complexity**
              Low
            - **Privileges required**
              None
            
            ---
            
            ## Information
            - **Package:** ${pkg} (${eco})
            - **Affected versions:** ${vulnRange}
            - **Patched version:** ${patched}
            
            ---
            
            ## References
            - https://github.com/advisories/${ghsa}
            - ${alert.html_url}
              `.trim();

              if (alert.state === 'open') {
                if (!existing) {
                  await github.rest.issues.create({
                    owner,
                    repo,
                    title,
                    body,
                    labels: ['Security', 'Auto Create Issues', 'do-not-autoclose'],
                    assignees: ['TheKingTermux']
                  });
                  console.log(`Created issue: ${title}`);
                } else {
                  await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number: existing.number,
                    body,
                    state: 'open'
                  });
                  console.log(`Updated issue: ${title}`);
                }
              }

              if (['dismissed', 'fixed'].includes(alert.state) && existing) {
                await github.rest.issues.update({
                  owner,
                  repo,
                  issue_number: existing.number,
                  state: 'closed',
                  state_reason: 'not_planned'
                });
                console.log(`Closed issue: ${title}`);
              }
            }
