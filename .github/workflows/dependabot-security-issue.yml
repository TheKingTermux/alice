name: ðŸ›¡ï¸ Dependabot Security PR â†’ Auto Create/Update Issue

on:
  pull_request:
    types: [opened, synchronize, closed, reopened]

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  process-dependabot-security-pr:
    if: github.event.pull_request.user.login == 'dependabot[bot]' && contains(github.event.pull_request.title, 'Bumps')  # filter Dependabot PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo (untuk context kalau perlu)
        uses: actions/checkout@v4

      - name: Extract vulnerability info from PR body & Create/Update Issue
        uses: actions/github-script@v7
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        with:
          script: |
            const { context, github } = require('@actions/github');
            const payload = context.payload;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Ambil PR body dari env (karena context.payload.pull_request.body kadang truncated)
            const prBody = process.env.PR_BODY || payload.pull_request.body || '';

            // Regex / string parse buat ambil data kunci (sesuaikan kalau body beda)
            let severity = 'UNKNOWN';
            let ghsa = 'No GHSA';
            let cve = 'No CVE';
            let cvss = 'N/A';
            let vector = 'N/A';
            let pkg = 'Unknown';
            let eco = 'Unknown';
            let vulnRange = 'Unknown';
            let patched = 'None';
            let summary = 'No summary available';

            // Parse severity (contoh: **Severity:** High atau dari advisory)
            const severityMatch = prBody.match(/\*\*Severity:\*\*\s*(\w+)/i) || prBody.match(/Severity:\s*(\w+)/i);
            if (severityMatch) severity = severityMatch[1].toUpperCase();

            // GHSA / CVE
            const ghsaMatch = prBody.match(/(GHSA[-a-zA-Z0-9]+)/);
            if (ghsaMatch) ghsa = ghsaMatch[1];
            const cveMatch = prBody.match(/(CVE-\d{4}-\d+)/);
            if (cveMatch) cve = cveMatch[1];

            // Package & versions (dari title atau body)
            const pkgMatch = prBody.match(/Bumps\s+([^\s]+)\s+from/) || process.env.PR_TITLE.match(/Bumps\s+([^\s]+)/);
            if (pkgMatch) pkg = pkgMatch[1];
            const rangeMatch = prBody.match(/Affected versions:\s*([^\\n]+)/i) || prBody.match(/vulnerable\s+versions:\s*([^\\n]+)/i);
            if (rangeMatch) vulnRange = rangeMatch[1].trim();
            const patchedMatch = prBody.match(/Patched in:\s*([^\\n]+)/i);
            if (patchedMatch) patched = patchedMatch[1].trim();

            // Summary (ambil paragraf pertama setelah Vulnerability details)
            const summaryMatch = prBody.match(/\*\*Vulnerability details\*\*([\s\S]*?)(?=\*\*|$)/i);
            if (summaryMatch) summary = summaryMatch[1].trim();

            // Title issue
            const title = `Security: ${severity} - ${pkg} (${ghsa} / ${cve})`;

            // Cari issue existing
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: 'all', labels: 'dependabot-security', per_page: 100 }
            );
            const existing = issues.find(i => i.title === title);

            // Body issue rapi mirip punyamu dulu
            const body = `
            ## ðŸ›¡ï¸ Security Vulnerability (from Dependabot PR #${process.env.PR_NUMBER})
            
            ### Description
            ${summary || 'Vulnerability detected in dependency. See PR for details.'}
            
            ### Severity Check
            - ${severity === 'LOW' ? 'â˜‘' : 'â˜'} Low
            - ${severity === 'MODERATE' ? 'â˜‘' : 'â˜'} Moderate
            - ${severity === 'HIGH' ? 'â˜‘' : 'â˜'} High
            - ${severity === 'CRITICAL' ? 'â˜‘' : 'â˜'} Critical
            
            ### Severity Score
            ${cvss} / 10
            
            ### CVSS Vector
            ${vector}
            
            ### Affected
            - **Package:** ${pkg}
            - **Ecosystem:** ${eco}
            - **Vulnerable versions:** ${vulnRange}
            - **Patched version:** ${patched}
            
            ### References
            - Advisory: https://github.com/advisories/${ghsa}
            - PR: ${process.env.PR_URL}
            - Dependabot Alert: https://github.com/${owner}/${repo}/security/dependabot/${process.env.PR_NUMBER ? 'related-to-pr-' + process.env.PR_NUMBER : 'unknown'}
            
            ---
            _Auto-generated from Dependabot security PR. Fix by merging PR #${process.env.PR_NUMBER}._
            `.trim();

            if (payload.action === 'opened' || payload.action === 'synchronize' || payload.action === 'reopened') {
              if (!existing) {
                await github.rest.issues.create({
                  owner, repo,
                  title,
                  body,
                  labels: ['Security', 'dependabot-security', 'Auto'],
                  assignees: ['TheKingTermux']
                });
                console.log(`Created issue: ${title}`);
              } else {
                await github.rest.issues.update({
                  owner, repo,
                  issue_number: existing.number,
                  body,
                  state: 'open'
                });
                console.log(`Updated issue: ${title}`);
              }
            }

            // Close issue kalau PR closed (merged atau rejected)
            if (payload.action === 'closed' && existing) {
              const labels = existing.labels.map(l => l.name);
              if (!labels.includes('do-not-autoclose')) {
                await github.rest.issues.update({
                  owner, repo,
                  issue_number: existing.number,
                  state: 'closed',
                  state_reason: 'completed'  // atau 'not_planned'
                });
                console.log(`Closed issue: ${title}`);
              }
            }
